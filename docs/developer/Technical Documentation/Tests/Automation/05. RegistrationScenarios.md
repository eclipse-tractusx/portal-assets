# Registration Scenarios

Registration process consists of several steps:

1. Execute invitation
2. Set company detail data with or without BPN
3. Send in-registration invitation (optional)
4. Choose user roles
5. Submit agreements
6. Upload of documents
7. Submit registration
8. Check of application detail by company name and status
9. Check of correctness of company data storage

where steps 1, 8 and 9 are completed with the token of the existing portal user for non-technical tests and for steps
2-7 a new user is created during invitation step with the help of one of the temporary email services.
The required for registration process data is fetched from the corresponding test data files.

The following scenarios are described here:

- [Happy path - new registration without BPN](#happy-path---new-registration-without-bpn)
- [Happy path - new registration with BPN](#happy-path---new-registration-with-bpn)
- [In-Registration member invitation](#in-registration-member-invitation)
- [Company detail data update](#company-detail-data-update)
- [UnHappy path - new registration without document](#unhappy-path---new-registration-without-document)

At each step of registration process it is also checked if CompanyApplicationStatusId corresponds to the step. If it
doesn't happen, an exception "Application status is not fitting to the pre-requisite" will be thrown.

## Happy path - new registration without BPN

This scenario tests if a user can successfully register a company without BPN after getting an invitation per email.
Necessary company detail data is taken from a test data file.

First the invitation is sent to a user via:

```
POST: api/administration/invitation
```

with the body

```
{
    "userName": "testuser",
    "firstName": "myFirstName",
    "lastName": "myLastName",
    "email": "string",
    "organisationName": "string"
}
```

where email is generated by temporary email service and organisationName is taken from the test data file. The rest data
is hardcoded.

Then company detail data from test data file is posted via:

```
POST: /api/registration/application/{applicationId}/companyDetailsWithAddress
```

Next the role agreements are submitted via:

```
POST: /api/registration/application/{applicationId}/companyRoleAgreementConsents
```

Necessary agreements are defined according to company roles from test data file.

Next a registration document is uploaded if it is provided as test data. Otherwise the test will fail.
Note: document of type "COMMERCIAL_REGISTER_EXTRACT" is mandatory.

```
POST: /api/registration/application/{applicationId}/documentType/{documentTypeId}/documents
```

The registration is submitted next:

```
POST: /api/registration/application/{applicationId}/submitRegistration
```

Afterwards it is checked if application status is "SUBMITTED" via:

```
GET: api/administration/registration/applications?companyName={companyName}
```

and if company detail data was stored correctly and corresponds the response of the GET call:

```
GET: api/administration/registration/application/{applicationId}/companyDetailsWithAddress
```

## Happy path - new registration with BPN

This scenario checks if a user can go through registration process with BPN. For this scenario company detail data is not relevant as it is defined by BPN. Other necessary information such as company roles, document type id and document name are fetched from the appropriate test data file.

First a random BPN is fetched from the BPDMN partner endpoint:

```
{BPDM_URL}/api/catena/legal-entities?page=0&size=20
```

To keep the name of the company unique a code with the date and time of creation is added to the name of the company. After sending invitation and providing a BPN the company address is fetched
via:

```
GET: /api/registration/legalEntityAddress/{bpn}
```

and then used to set company detail data.

All the following steps starting from submission of agreements are the same as in the scenario of registration without a
bpn.

## In-Registration member invitation

In-registration member invitation is an optional step in registration process and implemented thus as a separate
scenario.

First an invitation is sent as usual via:

```
POST: api/administration/invitation
```

invite member as additional user for existing company in registration process

```
Post: /api/registration/application/{applicationId}/inviteNewUser
```

with the following body where email is generated via temporary email service:

```
{
    "userName": "testuser2",
    "email": "string",
    "firstName": "myFirstName",
    "lastName": "myLastName",
    "roles": [
    "Company Admin"
    ],
    "message": "testMessage"
}
```

Finally it is checked if a user was invited and if this user gets a non-nullable and non-empty password to login in the
Catena-X Portal.

## Company detail data update

This scenario checks if user can confirm company detail data and then change it once again during registration process.
Company name, street and unique id will be updated and it will be validated if the updates have been stored successfully
in the database.

As usual invitation for a new user is created first. Then company detail data from companyDetailData from the
corresponding test data file is set via:

```
POST: /api/registration/application/{applicationId}/companyDetailsWithAddress
```

Next stored company data is validated as per input data:

```
GET: /api/registration/application/{applicationId}/companyDetailsWithAddress
```

Company name, street and unique id from updateCompanyDetailData object from the corresponding test data file are updated
via:

```
POST: /api/registration/application/{applicationId}/companyDetailsWithAddress
```

Afterwards stored company data is validated once more time to ensure that company data change was successful.

```
Get: /api/registration/application/{applicationId}/companyDetailsWithAddress
```

## UnHappy path - new registration without document

This scenario simulates a registration process without uploading a registration document. The first steps up to the
submission of agreements are the same as in happy paths with or without bpn.

After that the CompanyApplicationStatusId is explicitly set to "VERIFY" and an error is expected because of missing
documents.This logic is not implemented in productive code yet.

## NOTICE

This work is licensed under the [Apache-2.0](https://www.apache.org/licenses/LICENSE-2.0).

- SPDX-License-Identifier: Apache-2.0
- SPDX-FileCopyrightText: 2023 Contributors to the Eclipse Foundation
- Source URL: https://github.com/eclipse-tractusx/portal-assets
