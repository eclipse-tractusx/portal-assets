## User Management

We differenciate between real users and technical users (aka service accounts).
Both scenarios are completly automated / FE supported. There is no necessarity to setup/configure users in keycloak directly.

Evenmore it should get prohibited to create users via the keycloak admin console; reason: those users would be missing in the portal db since there is no snychronization back to the portal db. This would result into an internal service issue.
When using the available services for real and technical user creation; the issue wont appear since portal will create first of all the relevant user accounts in the portal db and afterwards create the same in keyloak.  
With help of the portal db table iam_users; the user id in keycloak central idp (user_entity_id) and the user id inside the portal (company_user_id) are linked.
For service accounts the mapper is the service account clientId.

<br>
<br>



### Technical User
For the type of technical (non-human) users, service accounts are to be used.
<br>
Service accounts differ from normal user accounts in multiple ways:
<br>
* They don't have a password and can't be used for browser-based sign-in.
* They're created and managed as a user that belongs to a client.
* How to setup technical user authentication
* The service account should have it's own client.
<br>
Each OIDC client has a built-in service account which allows it to obtain an access token. This is covered in the OAuth 2.0 specifiation under Client Credentials Grant. To use this feature the Access Type of your client is set to confidential.

<br>
<br>

#### Role Management
The technical user relevant roles are managed within a shadow client called "technical-user-management".

All composite roles available for technical user creation inside the portal are configured in this area.

Additionally, the role need to be available inside the portal db - user_roles.

<br>
<br>

### User Attributes

All users can get specific user attributes added - currently the following attributes are supported / implemented

* bpn-mapper
* username-mapper

<br>
<br>

#### bpn-mapper

The Business Partner Number (BPN) is a verified company credential which is getting added as attribute to each user inside the network.

The bpn provides an extended user authentication possibility.

<br>

How is the attribute added to the user

  * Option1: With the registration approval: with the registration, a user is invited without the company/bpn connection. The actual confirmation of user / BPN mapping will only take place with the registration approval => if the company registration is getting approved, a backend service is calling the function to add the company BPN to the respective user
  * Option 2: Automatically added with the user invite/creation: the IT Administrator is adding one or multiple users to the CX network. By doing so, the user accounts get created => as part of this flow, the newly created user(s) should get a user attribute added which is the same as the Company BPN from the table "company"
  * Option 3: Manual added, by permission (via the user management permission "add user"): by opening the user admin account inside the portal, the administrator can add another BPN to the user account. Currently without any limitations. However there is the plan to limit the functionality and to restrict the BPNs which can get selected / added by the admin


#### username-mapper

Is handling the username created for each user account inside the central idp.
{idpalias}+uuid

<br>
<br>

