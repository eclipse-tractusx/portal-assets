# Access Token Retrieval

While a normal user usually has access to access tokens by being signed in, when testing endpoints in an automated manner as part of a CI/CD pipeline it is needed to get access token for tests. For existing users, the token can be retrieved via the authentication flow using the company name, username and password. For new users invited during the registration process, a temporary email address needed to be created first in order to receive an email with a password. 

The implementation of 
* [Authentication Flow](#authentication-flow)
* [Use of disposable email addresses](#use-of-disposable-email-addresses)
  * [DeveloperMail API](#developermail-api)
  * [TempMail API](#tempmail-api)

will be explained now and can be found here:

```
..\tests\shared\Tests.Shared\EndToEndTests\AuthFlow
```


## Authentication Flow

...description to be added...


## Use of disposable email addresses

The registration process consists of an invitation step in which an administrator sends to a user an invitation to join the Catena-X Portal. To make it possible temporary email services are used.
Per default [DeveloperMail](https://developermail.com/api/v1/) is used as it is a free API with suitable limit on requests (only more than 25 requests in one second will result a HTTP 429 Too Many Requests response). In case if this API is not available [TempMail API](https://apilayer.com/marketplace/temp_mail-api) will be used as it is restricted to 500 requests in month and requires registration to get TempMailApiKey to access functionality.


### DeveloperMail API
The base url for requests to DeveloperMail API is:
```
https://developermail.com/api/v1
```

In order to get a username and password for a new user the following steps are executed:

* Generate a random email address
```
PUT: /mailbox
```

This endpoint returns a response that contains a username and an access token of the type "X-MailboxToken" for all other requests.

* Send invitation to user @ developermail.com (s. [RegistrationScenarios](05.%20RegistrationScenarios.md))

Important: a delay after sending invitation and before checking mailbox is implemented in order to give time for the emails to reach the mailbox.

* Get existing message ids
```
GET: /mailbox/{username}
```
* Check mailbox with the body consists of the list with the received ids
```
POST: /mailbox/{username}/messages
```
* Find email with password and fetch it

The password is searched in the first paragraph of the table that follows after the paragraph with the text 'Below you can find your password' in the email whose topic contains "Password required".

* Delete mailbox
```
DELETE: /mailbox/{username}
```
For security reasons the mailbox is deleted after fetching the password.


### TempMail API

To use TempMailApi registration is needed. After registration a TempMailApiKey will be sent to email and can be used to access API functionality. TempMailApiKey should be placed in Secrets.
The base url for requests to TempMail API is:
```
https://api.apilayer.com/temp_mail
```
* Get available domains
```
GET: /domains
```
In contrast to the first option here a random address is not generated, but a list of available domains is requested. Any username can be chosen, for now "apitestuser" is hardcoded.
* Send invitation to "apitestuser" @ one of available domains (s. [RegistrationScenarios](05.%20RegistrationScenarios.md))
* Get password message and fetch password
```
GET: /mail/id/{hashedEmailAddress}
```
where email address is hashed with MD5.

Similar to the approach described above the password is searched in the first paragraph of the table that follows after the paragraph with the text 'Below you can find your password' in the email whose topic contains "Password required".
* Delete password message
```
DELETE: /delete/id/{mailId}
```
Finally the password message is deleted after fetching the password for security reasons.

In both cases after getting the username and password, an authentication flow can be processed to get an access token for the user.

